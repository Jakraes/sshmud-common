name: Build & Release

on:
  push:
    branches: [ "main" ]          # change if you want other branches

permissions:
  contents: write                 # needed for creating releases / tags

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # -------------------------------------------------
      # 1. Checkout repository
      # -------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0           # needed for git describe if you switch to semver

      # -------------------------------------------------
      # 2. Install build tools (gcc, make, ar, ranlib)
      # -------------------------------------------------
      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      # -------------------------------------------------
      # 3. Build & install (your Makefile's `install` target)
      # -------------------------------------------------
      - name: Build library
        run: make install

      # -------------------------------------------------
      # 4. Compute next version
      # -------------------------------------------------
      - name: Compute version
        id: version
        run: |
          # Simple incremental version: 0.0.<workflow-run-number>
          RUN_NUMBER=${{ github.run_number }}
          echo "version=0.0.$RUN_NUMBER" >> $GITHUB_OUTPUT
          echo "Creating release v0.0.$RUN_NUMBER"

      # -------------------------------------------------
      # 5. Package the two artifacts (lib + include/)
      # -------------------------------------------------
      - name: Package release assets
        run: |
          mkdir -p release
          cp -r bin/libsshmud.a bin/include release/
          tar -czf sshmud-${{ steps.version.outputs.version }}.tar.gz -C release .
        id: package

      # -------------------------------------------------
      # 6. Create GitHub Release + upload asset
      # -------------------------------------------------
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            sshmud-${{ steps.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
